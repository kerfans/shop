<?php
/**
 * Created by JetBrains PhpStorm.
 * User: Administrator
 * Date: 13-5-8
 * Time: 上午11:54
 * To change this template use File | Settings | File Templates.
 */
class Mendian extends CI_Controller {

    public function __construct()
    {
        parent::__construct();
        $this->load->helper('url');
        $this->load->helper('num_to_upper');
        $this->load->model('mendian_model');
		$this->load->model('shopmodel');
        $this->load->library('pagination_fenye');
        $this->load->library('http_do');
        date_default_timezone_set('PRC');
       // error_reporting(E_ALL);
    }
    //异步获取限购数量
    function get_goods_limit($goods_id){
        $num=$this->mendian_model->get_goods_limit($goods_id);
        echo $num;
    }
    //异步获取当前的订单状态
    function get_curr_states($id){
        $order=$this->mendian_model->get_order_mess($id);
        echo $order['states'];
    }
    //根据状态的不同能执行哪行状态
    function check_states($id,$states){
        $order=$this->mendian_model->get_order_mess($id);
        $array_states=array();
        if($order['states']==0){          //未沟通
                      $array_states=array(1,5,6,4,8);
        }elseif($order['states']==1){    //已沟通
                      $array_states=array(2,4,8);
        }elseif($order['states']==2){    //已确认
                      $array_states=array(7,4,8);
        }elseif($order['states']==3){    //已完成
                      $array_states=array(4,8);
        }elseif($order['states']==4){    //已作废
                      $array_states=array(8);
        }elseif($order['states']==5){    //5沟通过但转预存款
                      $array_states=array(1,4,5,6,8);
        }elseif($order['states']==6){    //6沟通过但无法联系
                      $array_states=array(1,4,5,6,8);
        }elseif($order['states']==7){    //7已处理
                      $array_states=array(3,4,8);
        }elseif($order['states']==8){    //8售后
            $array_states=array(8);
        }elseif($order['states']==9){    //9违约订单
            $array_states=array(1,4,8);
        }elseif($order['states']==10){   //10违约订单
            $array_states=array(1,4,8);
        }elseif($order['states']==11){   //10违约订单
            $array_states=array(1,4,8);
        }
        if(!in_array($states,$array_states)){
            echo "该信息的状态已被改变，3秒后打开最新状态的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order['id']."/".$order['user_id']."/".$order['states']."';},3000);
                      </script>"; die();
        }

    }
    //显示列表信息    根据不同的状态
    function display($states,$pageNum=0){
        $count = $this->mendian_model->get_order_count($states);
        $config['base_url'] =SITE.'mendian/display/'.$states."/";
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination_fenye->initialize($config);
        $data["page"] =$this->pagination_fenye->create_links();
        $data["order"] =$this->mendian_model->get_order($states,$config['per_page'],$pageNum);
        $data["states"] = $states;
        $data["states_name"] =$this->states_name($states);
        foreach($data["order"] as $k=>$v){
            $res=$this->mendian_model->get_user_mess($v['user_id']);
            $data["order"][$k]['money']=$res[0]['user_money'];
            $data["order"][$k]['deliver_type_name']=$this->deliver_type_name($v['deliver_type']);
        }
        $this->load->view('mendian/display_tpl',$data);
    }
    //详细信息   根据不同的状态
    function detail_show($order_id,$user_id,$states){
        $data["order"]=$this->get_order_mess($order_id);
        if($states!=$data['order']['states']){
            echo "该信息的状态已被改变，3秒后打开最新状态的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$user_id."/".$data['order']['states']."';},3000);
                      </script>"; die();
        }
        $this->mendian_model->is_chakan($order_id);               //改变为已查看状态
        $goods=$this->mendian_model->get_goods_mess($order_id);
        $data["user"]=$this->mendian_model->get_user_mess($user_id);
        $data['user_rank']=$this->mendian_model->get_user_rank($user_id);
        $data["goods"]=$this->get_goods_price($user_id,$goods);   //根据会员等级获取商品价格
        //$data["goods"]=$goods;
        $data["address"]=$this->get_address($user_id);
        $data["log"]=$this->get_order_log($order_id);
        $data["states"] = $states;
        $data["states_name"] =$this->states_name($states);
        $data["order"]["deliver_type_name"] =$this->deliver_type_name($data["order"]['deliver_type']);
        $time=date('Y-m-d H:i:s', strtotime($data["order"]['addtime'])-60*60*24);
        $res=$this->mendian_model->get_order_num($user_id,$time,$data["order"]['addtime']);
        $data["order_num"] = $res;

        $province=$this->mendian_model->get_one_region($data["order"]['province']);
        $city=$this->mendian_model->get_one_region($data["order"]['city']);
        $district=$this->mendian_model->get_one_region($data["order"]['district']);
        $district_array=$this->mendian_model->getregion($data["order"]['city']);
        $data["order"]['province_name']=$province[0]['region_name'];
        $data["order"]['city_name']=$city[0]['region_name'];
        $data["order"]['district_name']=$district[0]['region_name'];
        $data["order"]['district_array']=$district_array;
        $detail_address=$data["order"]['address'];
        $data["order"]['address']=$province[0]['region_name'].$city[0]['region_name'].$district[0]['region_name'].$data["order"]['address'];
        if($states==0||$states==6){
            $data["order"]['address']=$detail_address;
            //判断库存开始=====================================
            $goods_kucun= "";
            if(!empty($data["goods"])&&$data["order"]['shop_id']>20){
                foreach($data["goods"] as $k=>$v){
                    $res=$this->goods_kucun_num($v['goods_id'], $data["order"]['shop_id']);
                    if($v['goods_num']>$res['stock']){
                        $goods_kucun.="，'".$v['goods_name']."'的购买数量超过了".$res['shop_name']."的库存量(".$res['stock'].")";
                    }
                }
            }
            $data["goods_kucun"] = trim($goods_kucun,"，");
            //判断库存结束=====================================
//            echo "<pre>";
//            print_r($data);
//            echo "</pre>";die();
            $this->load->view('mendian/detail_show_tpl',$data);
        }elseif($states==9||$states==11){
            $this->load->view('mendian/detail_show_system_back_tpl',$data);
        }else{
            $this->load->view('mendian/detail_show_other_tpl',$data);
        }
    }
    //判断库存结束=============================
    private  function goods_kucun_num($goods_id,$shop_id){
        $data=$this->mendian_model->goods_kucun_num($goods_id,$shop_id);
        return $data;
    }
    public function deliver_type_name($deliver_type){
        if($deliver_type==1){
            $deliver_type_name='自提';
        }elseif($deliver_type==2){
            $deliver_type_name='送货';
        }elseif($deliver_type==3){
            $deliver_type_name='快递';
        }elseif($deliver_type==4){
            $deliver_type_name='邮局';
        }else{
            $deliver_type_name='未选';
        }
        return $deliver_type_name;
    }
    public function states_name($states){
        if($states==0){
            $states_name='未沟通';
        }elseif($states==1){
            $states_name='已沟通';
        }elseif($states==2){
            $states_name='已确认';
        }elseif($states==7){
            $states_name='已处理';
        }elseif($states==3){
            $states_name='已完成';
        }elseif($states==4){
            $states_name='已作废';
        }elseif($states==5){
            $states_name='转预存款';
        }elseif($states==6){
            $states_name='无法联系';
        }elseif($states==9){
            $states_name='2小时违约需求';
        }elseif($states==10){
            $states_name='已取消的违约需求';
        }elseif($states==11){
            $states_name='经销商缺货退回';
        }elseif($states==12){
            $states_name='顾客拒收';
        }
        return $states_name;
    }
    //获取订单以及订单状态
    public function get_order_mess($order_id){
        $data=$this->mendian_model->get_order_mess($order_id);
        $data['states_name']=$this->states_name($data['states']);
        if($data['fukuan']==0){
            $data['fukuan_name']="门店收款";
        }elseif($data['fukuan']==1){
            $data['fukuan_name']="总部代收";
        }
        return $data;
    }
    public function add_states(){
        $this->check_states($_REQUEST['id'],$_REQUEST['states']);
        $total_array=array();
        foreach($_REQUEST['goods'] as $v){
            array_push($total_array,intval($v[1])*$v[2]);
        }
        $sum=array_sum($total_array)+$_REQUEST['fee'];
       // echo $sum."==".$_REQUEST['total'];echo gettype($sum);echo gettype($_REQUEST['total']);var_dump((string)$sum==$_REQUEST['total']);die();die();
        if((string)$sum==$_REQUEST['total']){
            $_REQUEST['total']==(string)$sum;
        }else{
            echo "金额出错，请重新提交,2秒后返回原页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".$_SERVER['HTTP_REFERER'] ."';},2000);
                      </script>"; die();
        }

        if($_REQUEST['states']==1){   //处理已沟通
            //判断库存开始======================================
            $goods_string="";
            $shop_id=$_REQUEST['shop_id_new']==0?$_REQUEST['shop_id_jiu']:$_REQUEST['shop_id_new'];
            if(!empty($_REQUEST['goods'])&&$shop_id>20){
               foreach($_REQUEST['goods'] as $k=>$v){
                   $goods_id=$this->mendian_model->get_goods_need($v[0]);
                   $res=$this->goods_kucun_num($goods_id['goods_id'], $shop_id);
                   if($v[1]>$res['stock']){
                       $goods_string.="，'".$goods_id['goods_name']."'的购买数量超过了".$res['shop_name']."的库存量(".$res['stock'].")";
                   }
               }
            }
            if($goods_string!=""){
                die(trim($goods_string,"，")."，请修改数量，否则无法提交");
            }
            //判断库存结束======================================

            //插入数据到要发的短信表中=======================
            if($_REQUEST['shop_id_new']==0){
                if($_REQUEST['shop_id_jiu']>20){
                    $this->mendian_model->insert_sms($_REQUEST['id'],date('Y-m-d H:i:s'));
                }
            }else{
                if($_REQUEST['shop_id_new']>20){
                    $this->mendian_model->insert_sms($_REQUEST['id'],date('Y-m-d H:i:s'));
                }
            }
            //插入数据到要发的短信表中=======================
            $this->add_goutong($_REQUEST);
        }elseif($_REQUEST['states']==5){  //处理转预存款
            $this->add_zhuan_money($_REQUEST);
        }else{
            echo "操作出错";
        }
    }
    //处理客服的信息
    public function add_goutong($array){
//        echo "<pre>";
//        print_r($array);
//        echo "</pre>";die();
        $order=$this->mendian_model->get_order_mess($array['id']);
        //echo $array['address']."==".$order['address'];die();
        if(trim($array['address'])!=trim($order['address'])){
            $con="地址由‘".$order['address']."’更改为‘".$array['address']."’";
            $this->md_order_log($_SESSION['username'],8,$array['id'],date('Y-m-d H:i:s'),$con);
        }
        if($array['states']==$order['states']){
            echo "该信息的状态已被改变，3秒后打开最新状态的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order['id']."/".$order['user_id']."/".$order['states']."';},3000);
                      </script>"; die();
        }
        if($array['fukuan']==1){//此方式是预存款支付，如果选择此方式就扣除预存款
            $user=$this->mendian_model->get_user_mess($array['user_id']);
            if($array['total']>$user[0]['user_money']){
                echo "预存款不足，请选择其他付款方式<script type='text/javascript'>setTimeout(function(){window.location.href ='".$_SERVER['HTTP_REFERER'] ."';},1000);</script>"; die();
            }else{
                //var_dump($_REQUEST);die();
                $array_log=array();
                $array_log['recharge_id']=$array['shop_id_new']==0?$array['shop_id_jiu']:$array['shop_id_new'];
                $array_log['user_id']=$array['user_id'];
                $array_log['user_money']=$array['total'];
                $array_log['frozen_money']=0;
                $array_log['rank_points']=0;
                $array_log['pay_points']=0;
                $array_log['change_time']=time();
                $array_log['change_desc']="咨询信息:".$array['id'];
                $array_log['change_type']=88;
                $array_log['shop_id']=$array['shop_id_new']==0?$array['shop_id_jiu']:$array['shop_id_new'];
                $array_log['admin_name']=$_SESSION['username'];
                $array_log['order_id']=0;
                $this->mendian_model->update_acccount($array['user_id'],$array['total']);  //更新预存款
                $this->mendian_model->pay_user_money($array_log);//扣款的支付预存款日志
            }
        }

//        if($array['shop_id_new']!=0&&$array['shop_id_new']!=$array['shop_id_jiu']){
//            $this->md_order_log($_SESSION['username'],'',$array['id'],date('Y-m-d H:i:s'),"",$array['shop_id_new']);//写入日志
//        }
        foreach($array['goods'] as $v){                     //更新md_need的数量
            $this->mendian_model->update_md_need($v[0],intval($v[1]));
        }
        $arr=array();
        $arr['id']=$array['id'];
        $arr['shop_id']=$array['shop_id_new']==0?$array['shop_id_jiu']:$array['shop_id_new'];
        $arr['states']=1;
        $arr['name']=$array['name'];
        $arr['tel']=$array['tel'];
        $arr['home_tel']=$array['home_tel'];
        $arr['district']=$array['district_id'];
        $arr['address']=$array['address'];
        $arr['youbian']=$array['youbian'];
        $arr['fukuan']=$array['fukuan'];
        $arr['deliver_type']=$array['deliver_type'];
        $arr['fee']=$array['fee'];
        $arr['total']=$array['total'];
        $arr['kefu_message']=$array['kefu_message'];
        $arr['b_name']=$_SESSION['username'];
        $arr['ctime']=date('Y-m-d H:i:s');
        $data=$this->mendian_model->update_md_order($arr);//更新md_order表
        if($data){
            $this->md_order_log($_SESSION['username'],1,$array['id'],date('Y-m-d H:i:s'),$array['caozuo_message'],$array['shop_id_new']);//写入操作日志
            $this->go($data,$array['states']);
        }
    }
    //处理转预存款
    public function add_zhuan_money($array){
       // var_dump($array);echo "222";die();
            if($array['shop_id_new']!=0&&$array['shop_id_new']!=$array['shop_id_jiu']){
                $this->md_order_log($_SESSION['username'],'',$array['id'],date('Y-m-d H:i:s'),$array['shop_id_new']);//写入日志
            }
            foreach($array['goods'] as $v){//更新md_need的数量
                $this->mendian_model->update_md_need($v[0],$v[1]);
            }
            $arr=array();
            $arr['id']=$array['id'];
            $arr['shop_id']=$array['shop_id_new']==0?$array['shop_id_jiu']:$array['shop_id_new'];
            $arr['states']=5;
            $arr['name']=$array['name'];
            $arr['tel']=$array['tel'];
            $arr['home_tel']=$array['home_tel'];
            $arr['district']=$array['district_id'];
            $arr['address']=$array['address'];
            $arr['youbian']=$array['youbian'];
            $arr['fukuan']=0;
            $arr['deliver_type']=$array['deliver_type'];
            $arr['fee']=$array['fee'];
            $arr['total']=$array['total'];
            $arr['kefu_message']=$array['kefu_message'];
            $arr['b_name']=$_SESSION['username'];
            $arr['ctime']=date('Y-m-d H:i:s');
            $data=$this->mendian_model->update_md_order($arr);//更新md_order表
            if($data){
                $this->md_order_log($_SESSION['username'],5,$array['id'],date('Y-m-d H:i:s'),$array['caozuo_message']);//写入操作日志
                $this->go($data,$array['states']);
            }
    }
    //确定 转预存款
    public function check_zhuan_money($order_id,$states,$fukuan,$message){
        $this->mendian_model->insert_sms($order_id,date('Y-m-d H:i:s'));
        $order=$this->mendian_model->get_order_mess($order_id);
        if($order['shop_id']>20){
            $this->mendian_model->insert_sms($_REQUEST['id'],date('Y-m-d H:i:s'));
        }
        if($states==$order['states']){
            echo "该信息的状态已被改变，3秒后打开最新状态的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$order['user_id']."/".$order['states']."';},3000);
                      </script>"; die();
        }
        if(!isset($order_id)||!isset($states)||!isset($fukuan))return;
        if(isset($order_id)){
            $order=$this->mendian_model->get_order_mess($order_id);
            $user=$this->mendian_model->get_user_mess($order['user_id']);
            if($fukuan==0){
                $this->mendian_model->check_zhuan_money($order_id,1,0); //转预存款的是更新为已沟通
                $this->md_order_log($_SESSION['username'],1,$order['id'],date('Y-m-d H:i:s'),$message);//写入操作日志
                $this->go(1,5);
            }else{
                if($order['total']>$user[0]['user_money']&&$fukuan==1){
                    echo "预存款不足，请选择其他付款方式<script type='text/javascript'>setTimeout(function(){window.location.href ='".$_SERVER['HTTP_REFERER'] ."';},1000);</script>"; die();
                }else{
                    //var_dump($_REQUEST);die();
                    $array_log=array();
                    $array_log['recharge_id']=$order['shop_id'];
                    $array_log['user_id']=$order['user_id'];
                    $array_log['user_money']=$order['total'];
                    $array_log['frozen_money']=0;
                    $array_log['rank_points']=0;
                    $array_log['pay_points']=0;
                    $array_log['change_time']=time();
                    $array_log['change_desc']="咨询信息:".$order['id'];
                    $array_log['change_type']=88;
                    $array_log['shop_id']=$order['shop_id'];
                    $array_log['admin_name']=$_SESSION['username'];
                    $array_log['order_id']=0;
                    $this->mendian_model->update_acccount($order['user_id'],$order['total']);  //更新预存款
                    $this->mendian_model->pay_user_money($array_log);//扣款的支付预存款日志
                    $this->mendian_model->check_zhuan_money($order_id,1,1); //转预存款的是更新为已沟通
                    $this->md_order_log($_SESSION['username'],1,$order['id'],date('Y-m-d H:i:s'),$message);//写入操作日志
                    $this->go(1,5);
                }
            }

        }else{
            echo "非法操作";
        }
    }
    //确认收货并写入海典号
    public function confirm_order($order_id,$states,$hai_id,$message){
        $res=$this->mendian_model->confirm_order($order_id,$states,$hai_id,date('Y-m-d H:i:s'));
        if($res){
            $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);//写入操作日志
            $this->go(true,$states);
        }
    }
    //确认处理写入派送号
    public function chuli($order_id,$states,$xiaohao_id,$message){
        $res=$this->mendian_model->chuli_order($order_id,$states,$xiaohao_id);
        if($res){
            $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);//写入操作日志
            $this->go(true,$states);
        }
    }
    //门店调配
    public function tiaopei(){
        if(isset($_REQUEST)&&!empty($_REQUEST)){
            $this->mendian_model->tiaopei($_REQUEST);
            $this->md_order_log($_SESSION['username'],$_REQUEST['tiaopei_states'],$_REQUEST['id'],date('Y-m-d H:i:s'),"",$_REQUEST['shop_id']);//写入操作日志
            $order=$this->mendian_model->get_order_mess($_REQUEST['id']);
            if($order['states']==9){
                echo "<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order['id']."/".$order['user_id']."/".$order['states']."';},1);
                      </script>"; die();
            }else{
                $this->go(1,1);
            }

        }
    }
    //根据会员等级计算商品的价格
    public function get_goods_price($user_id,$goods_array){
        $user_rank=$this->mendian_model->get_user_rank($user_id);
        foreach($goods_array as $k=>$v){
            $price=$this->mendian_model->get_promote_price($v['goods_id'],time());
            if($price&&$price[0]['promote_price']>0){
                $goods_array[$k]['price']=$price[0]['promote_price'];
            }else{
                $goods_array[$k]['price']=$this->mendian_model->get_price($user_rank[0]['user_rank'],$v['goods_id']);
            }

        }
        return $goods_array;
    }
    //获取会员的收货地址
    public function get_address($user_id){
        $address=$this->mendian_model->get_address($user_id);
        foreach($address as $k=>$v){
            $pro=$this->mendian_model->get_one_region($v['province']);
            $city=$this->mendian_model->get_one_region($v['city']);
            if($v['district']!=0){
                $dis=$this->mendian_model->get_one_region($v['district']);
            }
            $address[$k]['address']=$pro[0]['region_name'].$city[0]['region_name'].$dis[0]['region_name']." ".$v['address'];
            unset($address[$k]['province']);
            unset($address[$k]['city']);
            unset($address[$k]['district']);
        }
        $addr=array();
        foreach($address as $k=>$v){
            $addr[$k]=implode("#",$v);
        }
        return $addr;
    }
    //更新订单的状态 无法联系的
    function update_states($order_id,$states,$message){
        $this->check_states($order_id,$states);
        if($states==8){//是售后的情况不执行
            $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);
            echo "操作成功<script>setTimeout(function(){window.location.href ='".$_SERVER['HTTP_REFERER'] ."';},1000);</script>";
        }else{
            $data=$this->mendian_model->update_order_state($order_id,$states);
            if($data){
                $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);
                $this->go(true,$states);
            }
        }
    }
    //还原的操作
    function huanyuan_states($order_id,$user_id,$states,$message){
        $data=$this->mendian_model->update_order_state($order_id,$states);
        if($data){
            if($message==""){
                $message='操作还原功能';
            }
            $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);
            echo "还原成功，2秒后返回未沟通的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$user_id."/".$states."';},2000);
                      </script>";
        }
    }
    //作废
    function del($order_id,$states,$message){
        $this->check_states($order_id,$states);
        $order=$this->mendian_model->get_order_mess($order_id);
        if($order['shop_id']<21){
            if($_SESSION['username']!="jw_1120"&&$_SESSION['username']!="jw_3512"&&$_SESSION['username']!="技术部测试"){
                if($order['states']==3||$order['sign_id']!=""||$order['xiao_id']!=""){
                    die("该需求单已完成或者已发货，不能作废，请联系门店相关人员");
                }
            }
        }
        if($states==$order['states']){
            echo "该信息的状态已被改变，3秒后打开最新状态的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$order['user_id']."/".$order['states']."';},3000);
                      </script>"; die();
        }
        if($order['fukuan']==1){   //把支付的预存款打回会员原账户
            $array_log=array();
            $array_log['recharge_id']=$order['shop_id'];
            $array_log['user_id']=$order['user_id'];
            $array_log['user_money']=$order['total'];
            $array_log['frozen_money']=0;
            $array_log['rank_points']=0;
            $array_log['pay_points']=0;
            $array_log['change_time']=time();
            $array_log['change_desc']="作废咨询信息:".$order_id;
            $array_log['change_type']=88;
            $array_log['shop_id']=$order['shop_id'];
            $array_log['admin_name']=$_SESSION['username'];
            $array_log['order_id']=0;
            $this->mendian_model->update_acccount($order['user_id'],-$order['total']);    //更新预存款
            $this->mendian_model->back_user_money($array_log);                                  //退款的支付预存款日志
        }
        $data=$this->mendian_model->update_order_state($order_id,$states);
        if($data){
            $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);//写入日志
            $this->go($data,$states);
        }
    }
    //再次分配
    function fenpei_once($order_id,$states,$message){
        $order=$this->mendian_model->get_order_mess($order_id);
        if($states==$order['states']){
            echo "该信息的状态已被改变，3秒后打开最新状态的页面<script type='text/javascript'>
                      setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$order['user_id']."/".$order['states']."';},3000);
                      </script>"; die();
        }
        if($order['fukuan']==1){   //把支付的预存款打回会员原账户
            $array_log=array();
            $array_log['recharge_id']=$order['shop_id'];
            $array_log['user_id']=$order['user_id'];
            $array_log['user_money']=$order['total'];
            $array_log['frozen_money']=0;
            $array_log['rank_points']=0;
            $array_log['pay_points']=0;
            $array_log['change_time']=time();
            $array_log['change_desc']="作废咨询信息:".$order_id;
            $array_log['change_type']=88;
            $array_log['shop_id']=$order['shop_id'];
            $array_log['admin_name']=$_SESSION['username'];
            $array_log['order_id']=0;
            $this->mendian_model->update_acccount($order['user_id'],-$order['total']);    //更新预存款
            $this->mendian_model->back_user_money($array_log);                                  //退款的支付预存款日志
        }
        $data=$this->mendian_model->update_order_state($order_id,$states);
        if($data){
            $this->md_order_log($_SESSION['username'],$states,$order_id,date('Y-m-d H:i:s'),$message);//写入日志
            $this->go($data,$states);
        }
    }
    //公共的跳转
    function go($data,$states){
        if($data){
            echo "操作成功<script>setTimeout(function(){window.location.href ='".SITE."mendian/display/".$states."';},1000);</script>";
        }else{
            echo "操作失败<script>setTimeout(function(){window.location.href ='".SITE."mendian/display/".$states."';},1000);</script>";
        }
    }
    //根据省级获取市级
    function get_city($pro_id){
        $data=$this->mendian_model->getregion($pro_id);
        $string="<option value='0'>请选择市级</option>";
        foreach($data as $k=>$v){
            $string.="<option value='".$v['region_id']."'>".$v['region_name']."</option>";
        }
        echo  $string;
    }
    //根据市级获取区级
    function get_dis($city_id){
        $data=$this->mendian_model->getregion($city_id);
        $string="<option value='0'>请选择区级</option>";
        if(!empty($data)){
            foreach($data as $k=>$v){
                    $string.="<option value='".$v['region_id']."'>".$v['region_name']."</option>";
            }
        }else{
            $string=0;
        }
        echo  $string;
    }
    //保存地址
    function save_address(){
        $address=explode(" ",$_REQUEST['address']);
        if($address[1]!=""){
            unset($address[0]);
            $_REQUEST['address']=implode("",$address);
        }else{
            $_REQUEST['address']=$address[0];
        }
        $res=$this->mendian_model->save_address($_REQUEST);
        if($res>0){
            echo 1;
        }else{
            echo 0;
        }
    }
    //写入日志
    function md_order_log($name,$states,$order_id,$time,$message,$shop_id=""){
        $this->mendian_model->md_order_log($name,$states,$order_id,$time,urldecode($message),$shop_id);
    }
    //查看库存
    function kucun($id){
        redirect('http://manager.yaofang.cn/search_product/Search_do?product_code='.$id,'location');
    }
    //添加需求
    public function add_need(){
        redirect('http://manager.yaofang.cn/notc_new1210/add_notc_info_new','location');
    }
    //会员注册
    public function reg_user(){
        redirect('http://manager.yaofang.cn/user/user_register','location');
    }
    //获取操作日志
    function get_order_log($order_id){
        $data=$this->mendian_model->get_order_log($order_id);
        $array=array();
//        foreach($data as $k=>$v){
//            if($v['shop_id']==""||$v['shop_id']==0){
//                if($v['name']=='0'){
//                    $data[$k]['name']='客户';
//                }
//                if($v['states']==0){
//                    $data[$k]['states']='提交咨询信息，未沟通';
//                }elseif($v['states']==1){
//                    $data[$k]['states']='已沟通';
//                }elseif($v['states']==2){
//                    $data[$k]['states']='已确认';
//                }elseif($v['states']==3){
//                    $data[$k]['states']='已完成';
//                }elseif($v['states']==4){
//                    $data[$k]['states']='已作废';
//                }elseif($v['states']==5){
//                    $data[$k]['states']='进行沟通，转预存款';
//                }elseif($v['states']==6){
//                    $data[$k]['states']='进行沟通，但无法联系';
//                }elseif($v['states']==7){
//                    $data[$k]['states']='已处理';
//                }elseif($v['states']==8){
//                    $data[$k]['states']='售后';
//                }
//            }else{
//                if($v['name']!='0'){
//                    $data[$k]['states']='调配到:'.$v['shop_name'];
//                }else{
//                    $data[$k]['name']='前台顾客';
//                    $data[$k]['states']='咨询信息提交到:'.$v['shop_name']."，未沟通。";
//                }
//            }
//            if($v['name']!='0'){
//                $message=$v['message']==""?'。未留言。':"。留言内容：".$v['message'];
//                $array[$k]=$v['time']." ".$data[$k]['name'].' 操作，状态为：'.$data[$k]['states'].$message;
//            }else{
//                $array[$k]=$v['time']." ".$data[$k]['name'].' 操作，状态为：'.$data[$k]['states'];
//            }
//        }
       // var_dump($data);
        foreach($data as $k=>$v){
                if($v['states']==0){
                    $data[$k]['states']='提交咨询信息，未沟通';
                }elseif($v['states']==1){
                    $data[$k]['states']='已沟通';
                }elseif($v['states']==2){
                    $data[$k]['states']='已确认';
                }elseif($v['states']==3){
                    $data[$k]['states']='已完成';
                }elseif($v['states']==4){
                    $data[$k]['states']='已作废';
                }elseif($v['states']==5){
                    $data[$k]['states']='进行沟通，转预存款';
                }elseif($v['states']==6){
                    $data[$k]['states']='进行沟通，但无法联系';
                }elseif($v['states']==7){
                    $data[$k]['states']='已处理';
                }elseif($v['states']==8){
                    $data[$k]['states']='售后';
                }elseif($v['states']==9){
                    $data[$k]['states']='2小时违约订单';
                }elseif($v['states']==10){
                    $data[$k]['states']='取消违约订单';
                }elseif($v['states']==11){
                    $data[$k]['states']='经销商缺货退回';
                }elseif($v['states']==12){
                    $data[$k]['states']='顾客拒收';
                }
            $name=$v['name']=='0'?"前台顾客":$v['name'];
            $message=$v['message']==""?'':"。留言内容：<strong style='color:#000'>".$v['message']."。</strong>";
            if($v['shop_id']==""||$v['shop_id']==0){
                $array[$k]=$v['time']."，".$name." 操作，状态为：<span style='color:green'>".$data[$k]['states']."</span>".$message;
            }else{
                $array[$k]=$v['time']."，".$name." 操作，选择：<span style='color:green'>".$v['shop_name']."。</span>状态为：<span style='color:green'>".$data[$k]['states']."</span>".$message;
            }
        }
        return $array;
    }
    //显示查询页面
    function search_show(){
        $data['ren']=$this->mendian_model->get_ren();
        $data['mendian']=$this->get_all_mendian();
        $this->load->view('mendian/search_show_tpl',$data);
    }
    //显示导出明细页面
    function search_show_detail(){
        $this->load->view('mendian/search_show_detail_tpl');
    }
    //获取全部门店
    function get_all_mendian(){
        $res=$this->mendian_model->get_all_mendian();
        $string="";
        $string.="<option value='0'>请选择门店</option>";
        foreach($res as $k=>$v){
            $shop_id=$v['shop_id'];
            $shop_name=$v['shop_name'];
            $string.="<option value='".$shop_id."'>".$shop_name."</option>";
        }
        return  $string;
    }
    //导出明细
    function goods_detail(){
        if(isset($_REQUEST['goods_detail'][0])&&!empty($_REQUEST['goods_detail'][1])){
            if($_REQUEST['goods_detail'][0]==$_REQUEST['goods_detail'][1]){
                $where="o.addtime='{$_REQUEST['goods_detail'][0]}'";
            }else{
                $where="o.addtime between '{$_REQUEST['goods_detail'][0]}' and '{$_REQUEST['goods_detail'][1]}'";
            }
            $data=$this->mendian_model->goods_detail($where);
            foreach($data as $k=>$v){
                $data[$k]['states_name']=$this->states_name($v['states']);
                if($v['fukuan']==0){
                    $data[$k]['fukuan']="门店收款";
                }elseif($v['fukuan']==1){
                    $data[$k]['fukuan']="总部代收";
                }
            }

//            echo "<pre>";
//            print_r($data);
//            echo "</pre>";die();
            $title="商品明细查询结果.csv";
            header("Content-type:application/vnd.ms-csv;charset=UTF-8");
            header("Content-Disposition:filename=".$title);
            echo iconv('UTF-8','gb2312',"用户ID,订单ID,用户名,收货人,电话,咨询人,咨询电话,商品名称,商品ID,新商品ID,商品编码,数量,合计,付款方式,状态,海典单号,派送单号,咨询时间,处理时间,完成时间,咨询者,处理者,处理门店,来源\t\n");
            if(!empty($data)){
                foreach($data as $v){
                    echo iconv('UTF-8','gb2312',$v['user_id'].",");
                    echo iconv('UTF-8','gb2312',$v['id'].",");
                    echo iconv('UTF-8','gb2312',$v['username'].",");
                    echo iconv('UTF-8','gb2312',$v['customer_name'].",");
                    echo iconv('UTF-8','gb2312',$v['customer_tel'].",");
                    echo iconv('UTF-8','gb2312',$v['name'].",");
                    echo iconv('UTF-8','gb2312',$v['tel'].",");
                    echo iconv('UTF-8','gb2312',$v['goods_name'].",");
                    echo iconv('UTF-8','gb2312',$v['goods_id'].",");
                    echo iconv('UTF-8','gb2312',$v['wareid'].",");
                    echo iconv('UTF-8','gb2312',$v['goods_sn_id'].",");
                    echo iconv('UTF-8','gb2312',$v['goods_num'].",");
                    echo iconv('UTF-8','gb2312',$v['total'].",");
                    echo iconv('UTF-8','gb2312',$v['fukuan'].",");
                    echo iconv('UTF-8','gb2312',$v['states_name'].",");
                    echo iconv('UTF-8','gb2312',$v['sign_id'].",");
                    echo iconv('UTF-8','gb2312',$v['xiao_id'].",");
                    echo iconv('UTF-8','gb2312',$v['addtime'].",");
                    echo iconv('UTF-8','gb2312',$v['ctime'].",");
                    echo iconv('UTF-8','gb2312',$v['ftime'].",");
                    echo iconv('UTF-8','gb2312',$v['a_name'].",");
                    echo iconv('UTF-8','gb2312',$v['b_name'].",");
                    echo iconv('UTF-8','gb2312',$v['from_id'].",");
                    echo iconv('UTF-8','gb2312',$v['shop_name'].",\n");
                }
            }
        }else{
            echo "开始时间和结束时间不能为空，请返回页面重新操作";
        }
    }
    //提交查询
    function search($s="",$pageNum=0){
        //var_dump($_REQUEST);
        if(isset($_REQUEST)&&!empty($_REQUEST)){
            $_SESSION['search_tj']="";
            $tj_display="";
            if($_REQUEST['id']!=""){
                $_SESSION['search_tj'].=" and o.id=".$_REQUEST['id'];
                $tj_display.="&nbsp;&nbsp;编号:".$_REQUEST['id'];
            }
            if($_REQUEST['goods_name']!=""){
                $_SESSION['search_tj'].=" and g.goods_name like '".$_REQUEST['goods_name']."%'";
                $tj_display.="&nbsp;&nbsp;商品名称:".$_REQUEST['goods_name'];
            }
            if($_REQUEST['username']!=""){
                $user=$this->mendian_model->get_one_user($_REQUEST['username']);
                $_SESSION['search_tj'].=" and o.user_id='".$user[0]['userid']."'";
                $tj_display.="&nbsp;&nbsp;会员名称:".$_REQUEST['username'];
            }
            if($_REQUEST['customer_name']!=""){
                $_SESSION['search_tj'].=" and o.customer_name='".$_REQUEST['customer_name']."'";
                $tj_display.="&nbsp;&nbsp;客户姓名:".$_REQUEST['customer_name'];
            }
            if($_REQUEST['customer_tel']!=""){
                $_SESSION['search_tj'].=" and o.customer_tel='".$_REQUEST['customer_tel']."'";
                $tj_display.="&nbsp;&nbsp;客户电话:".$_REQUEST['customer_tel'];
            }
            if($_REQUEST['name']!=""){
                $_SESSION['search_tj'].=" and o.name='".$_REQUEST['name']."'";
                $tj_display.="&nbsp;&nbsp;收货人姓名:".$_REQUEST['name'];
            }
            if($_REQUEST['tel']!=""){
                $_SESSION['search_tj'].=" and o.tel='".$_REQUEST['tel']."'";
                $tj_display.="&nbsp;&nbsp;收货人手机号:".$_REQUEST['tel'];
            }
            if($_REQUEST['home_tel']!=""){
                $_SESSION['search_tj'].=" and o.home_tel='".$_REQUEST['home_tel']."'";
                $tj_display.="&nbsp;&nbsp;收货人座机号:".$_REQUEST['home_tel'];
            }
            //海典单号
            if($_REQUEST['sign_id']!=""){
                $_SESSION['search_tj'].=" and o.sign_id='".$_REQUEST['sign_id']."'";
                $tj_display.="&nbsp;&nbsp;付款方式:".$_REQUEST['fukuan'];
            }
            //派送单号
            if($_REQUEST['xiao_id']!=""){
                $_SESSION['search_tj'].=" and o.xiao_id='".$_REQUEST['xiao_id']."'";
                $tj_display.="&nbsp;&nbsp;付款方式:".$_REQUEST['fukuan'];
            }
            //付款方式
            if($_REQUEST['fukuan']!=""){
                $_SESSION['search_tj'].=" and o.fukuan='".$_REQUEST['fukuan']."'";
                $tj_display.="&nbsp;&nbsp;付款方式:".$_REQUEST['fukuan'];
            }
            //负责门店
            if($_REQUEST['shop_id']!=0){
                $_SESSION['search_tj'].=" and o.shop_id='".$_REQUEST['shop_id']."'";
                $data=$this->mendian_model->get_one_mendian($_REQUEST['shop_id']);
                $tj_display.="&nbsp;&nbsp;负责门店:".$data[0]['shop_name'];
            }
            //分组门店
            if($_REQUEST['shop_id_fenzu']!=0){
                if($_REQUEST['shop_id_fenzu']==1){ //全部直营
                    $_SESSION['search_tj'].=" and o.shop_id in(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,20)";
                }elseif($_REQUEST['shop_id_fenzu']==2){ //京内
                    $_SESSION['search_tj'].=" and o.shop_id in(1,2,3,4,5,6,7,8,9,10)";
                }elseif($_REQUEST['shop_id_fenzu']==3){ //京外
                    $_SESSION['search_tj'].=" and o.shop_id in(11,12,13,14,15,16,17)";
                }elseif($_REQUEST['shop_id_fenzu']==4){ //加盟商
                    $_SESSION['search_tj'].=" and o.shop_id not in(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,20)";
                }
                $tj_display.="&nbsp;&nbsp;分组门店:".$data[0]['shop_name'];
            }
            //信息状态
            if(isset($_REQUEST['states'])&&!empty($_REQUEST['states'])){
                $string="and";
                if(count($_REQUEST['states'])==1){
                    $string.=" o.states='".$_REQUEST['states'][0]."'";
                }else{
                    for($i=0;$i<count($_REQUEST['states']);$i++){
                        if($i==0){
                            $string.="(o.states='".$_REQUEST['states'][$i]."'";
                        }elseif($i==(count($_REQUEST['states'])-1)){
                            $string.=" or o.states='".$_REQUEST['states'][$i]."')";
                        }else{
                            $string.=" or o.states='".$_REQUEST['states'][$i]."'";
                        }
                    }
                }
                $_SESSION['search_tj'].=$string;
//          $states_name=$this->states_name($_REQUEST['states']);
//          $tj_display.="&nbsp;&nbsp;信息状态:".$states_name;
            }
            //信息收集员
            if($_REQUEST['a_name']!=""){
                $_SESSION['search_tj'].=" and o.a_name='".$_REQUEST['a_name']."'";
                //$tj_display.="&nbsp;&nbsp;信息收集员:".$states_name;
            }
            //药师回访员
            if($_REQUEST['b_name']!=""){
                $_SESSION['search_tj'].=" and o.b_name='".$_REQUEST['b_name']."'";
                //$tj_display.="&nbsp;&nbsp;药师回访员:".$states_name;
            }
            //完成时间
            if(isset($_REQUEST['ftime'][0])&&!empty($_REQUEST['ftime'][1])){
                if($_REQUEST['ftime'][0]==$_REQUEST['ftime'][1]){
                    $_SESSION['search_tj'].=" and o.ftime='{$_REQUEST['ftime'][0]}'";
                    $tj_display.="&nbsp;&nbsp;完成时间:".$_REQUEST['ftime'][0];
                }else{
                    $_SESSION['search_tj'].=" and o.ftime between '{$_REQUEST['ftime'][0]}' and '{$_REQUEST['ftime'][1]}'";
                    $tj_display.="&nbsp;&nbsp;完成时间:".$_REQUEST['ftime'][0]."-".$_REQUEST['ftime'][1];
                }
            }
            //金额
            if(isset($_REQUEST['total'][0])&&!empty($_REQUEST['total'][1])){
                if($_REQUEST['total'][0]==$_REQUEST['total'][1]){
                    $_SESSION['search_tj'].=" and o.total='{$_REQUEST['total'][0]}'";
                    $tj_display.="&nbsp;&nbsp;金额:".$_REQUEST['total'][0];
                }else{
                    $_SESSION['search_tj'].=" and o.total between '{$_REQUEST['total'][0]}' and '{$_REQUEST['total'][1]}'";
                    $tj_display.="&nbsp;&nbsp;金额:".$_REQUEST['total'][0]."-".$_REQUEST['total'][1];
                }
            }
            //咨询时间
            if(isset($_REQUEST['addtime'][0])&&!empty($_REQUEST['addtime'][1])){
                if($_REQUEST['addtime'][0]==$_REQUEST['addtime'][1]){
                    $_SESSION['search_tj'].=" and o.addtime='{$_REQUEST['addtime'][0]}'";
                    $tj_display.="&nbsp;&nbsp;咨询时间:".$_REQUEST['addtime'][0];
                }else{
                    $_SESSION['search_tj'].=" and o.addtime between '{$_REQUEST['addtime'][0]}' and '{$_REQUEST['addtime'][1]}'";
                    $tj_display.="&nbsp;&nbsp;咨询时间:".$_REQUEST['addtime'][0]."-".$_REQUEST['addtime'][1];
                }
            }
            //回访时间
            if(isset($_REQUEST['ctime'][0])&&!empty($_REQUEST['ctime'][1])){
                if($_REQUEST['ctime'][0]==$_REQUEST['ctime'][1]){
                    $_SESSION['search_tj'].=" and o.ctime='{$_REQUEST['ctime'][0]}'";
                    $tj_display.="&nbsp;&nbsp;回访时间:".$_REQUEST['ctime'][0];
                }else{
                    $_SESSION['search_tj'].=" and o.ctime between '{$_REQUEST['ctime'][0]}' and '{$_REQUEST['ctime'][1]}'";
                    $tj_display.="&nbsp;&nbsp;回访时间:".$_REQUEST['ctime'][0]."-".$_REQUEST['ctime'][1];
                }
            }
            $_SESSION['search_tj']=trim($_SESSION['search_tj']," ");
        }
        $count = $this->mendian_model->get_search_count();
        $config['base_url'] =SITE.'mendian/search/0/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination_fenye->initialize($config);
        $data["page"] =$this->pagination_fenye->create_links();
        $data["order"] =$this->mendian_model->get_search($config['per_page'],$pageNum);
        foreach($data["order"] as $k=>$v){
            $data["order"][$k]['states_name']=$this->states_name($v['states']);
            $data["order"][$k]['deliver_type_name']=$this->deliver_type_name($v['deliver_type']);
        }
        $data["tj_display"] = $tj_display;
        $this->load->view('mendian/search_display_tpl',$data);
    }
    //打印条形码
    function dayin_txm($order_id,$user_id){
        $data["goods"]=$this->mendian_model->get_goods_mess($order_id);
        $data["order"]=$this->get_order_mess($order_id);
//        echo "<pre>";
//        print_r($data["goods"]);
//        echo "</pre>";
        $this->load->view('mendian/dayin_txm_tpl',$data);
    }
    //打印
    function dayin($order_id,$user_id){
        $goods=$this->mendian_model->get_goods_mess($order_id);
        $data["user"]=$this->mendian_model->get_user_mess($user_id);
        $data["goods"]=$this->get_goods_price($user_id,$goods);   //根据会员等级获取商品价格
        foreach($data["goods"] as $k=>$v){
            $res=$this->mendian_model->get_goods_detail($v['goods_id']);
            $data["goods"][$k]['guige']=$res[0]['guige'];
        }
        $data["order"]=$this->get_order_mess($order_id);
        $this->load->view('mendian/dayin_tpl',$data);
    }
//    //查询详情
//    function search_detail($order_id,$user_id,$states){
//        $this->mendian_model->is_chakan($order_id);               //改变为已查看状态
//        $goods=$this->mendian_model->get_goods_mess($order_id);
//        $data["user"]=$this->mendian_model->get_user_mess($user_id);
//        $data["goods"]=$this->get_goods_price($user_id,$goods);   //根据会员等级获取商品价格
//        $data["order"]=$this->get_order_mess($order_id);
//        $data["address"]=$this->get_address($user_id);
//        $data["log"]=$this->get_order_log($order_id);
//        $data["states"] = $states;
//        $data["states_name"] =$this->states_name($states);
//        $this->load->view('mendian/detail_show_other_tpl',$data);
//    }
    //导出查询的数据
    function export(){
        $data=$this->mendian_model->export();
        foreach($data as $k=>$v){
            $data[$k]['states_name']=$this->states_name($v['states']);
            if($v['fukuan']==0){
                $data[$k]['fukuan']="门店收款";
            }elseif($v['fukuan']==1){
                $data[$k]['fukuan']="总部代收";
            }
            $data[$k]['customer_name']=trim($data[$k]['customer_name']);
            $data[$k]['customer_tel']=trim($data[$k]['customer_tel']);
            $data[$k]['user_id']=trim($data[$k]['user_id']);
            $data[$k]['fee']=trim($data[$k]['fee']);
            $data[$k]['customer_name']=trim($data[$k]['customer_name']);
            $data[$k]['customer_tel']=trim($data[$k]['customer_tel']);
            $data[$k]['customer_name']=trim($data[$k]['customer_name']);
            $data[$k]['customer_tel']=trim($data[$k]['customer_tel']);
            $data[$k]['address']=trim(str_replace(","," ",$data[$k]['address']));
            if($v['states']==6){
                 $res=$this->mendian_model->get_name_from_md_order_log($v['id'],$v['states']);
                 $data[$k]['b_name']=$res[0]['name'];
            }
        }
//        echo $data[0]['address']."===";
//        echo iconv('UTF-8','gbk',$data[0]['address'].",");
//        echo '<pre>';
//        var_dump($data);
//        echo '</pre>';die();
        $title=$_SESSION['username']."信息查询结果.csv";
        header("Content-type:application/vnd.ms-csv;charset=gb2312");
        header("Content-Disposition:filename=".$title);
        //echo "编号,海典单号,派送单号,处理门店,会员ID,会员名称,顾客姓名,顾客电话,地址,付款方式,配送费,合计,咨询时间,完成时间,来源\t\n";
        echo iconv('UTF-8','gb2312',"编号,内部单号,派送单号,处理门店,会员ID,会员名称,付款方式,配送费,合计,咨询时间,完成时间,来源,信息收集员,药师回访员,状态\t\n");
                if(!empty($data)){
                    foreach($data as $v){
//                        echo $v['id'].",";
//                        echo $v['sign_id'].",";
//                        echo $v['xiao_id'].",";
//                        echo $v['shop_name'].",";
//                        echo $v['user_id'].",";
//                        echo $v['username'].",";
//                        echo $v['customer_name'].",";
//                        echo $v['customer_tel'].",";
//                        echo $v['address'].",";
//                        echo $v['fukuan'].",";
//                        echo $v['fee'].",";
//                        echo $v['total'].",";
//                        echo $v['addtime'].",";
//                        echo $v['ftime'].",";
//                        echo $v['from_id'].",\n";
                        echo iconv('UTF-8','gb2312',$v['id'].",");
                        echo iconv('UTF-8','gb2312',$v['sign_id'].",");
                        echo iconv('UTF-8','gb2312',$v['xiao_id'].",");
                        echo iconv('UTF-8','gb2312',$v['shop_name'].",");
                        echo iconv('UTF-8','gb2312',$v['user_id'].",");
                        echo iconv('UTF-8','gb2312',$v['username'].",");
//                        echo iconv('UTF-8','gb2312',$v['customer_name'].",");
//                        echo iconv('UTF-8','gb2312',$v['customer_tel'].",");
//                        echo iconv('UTF-8','gb2312',$v['address'].",");
                        echo iconv('UTF-8','gb2312',$v['fukuan'].",");
                        echo iconv('UTF-8','gb2312',$v['fee'].",");
                        echo iconv('UTF-8','gb2312',$v['total'].",");
                        echo iconv('UTF-8','gb2312',$v['addtime'].",");
                        echo iconv('UTF-8','gb2312',$v['ftime'].",");
                        echo iconv('UTF-8','gb2312',$v['from_id'].",");
                        echo iconv('UTF-8','gb2312',$v['a_name'].",");
                        echo iconv('UTF-8','gb2312',$v['b_name'].",");
                        echo iconv('UTF-8','gb2312',$v['states_name'].",\n");
                    }
                }
//        echo iconv('UTF-8','gb2312',"海典单号,");
//        echo iconv('UTF-8','gb2312',"派送单号,");
//        echo iconv('UTF-8','gb2312',"处理门店,");
//        echo iconv('UTF-8','gb2312',"会员ID,");
//        echo iconv('UTF-8','gb2312',"会员名称,");
//        echo iconv('UTF-8','gb2312',"顾客姓名,");
//        echo iconv('UTF-8','gb2312',"顾客电话,");
//        echo iconv('UTF-8','gb2312',"地址,");
//        echo iconv('UTF-8','gb2312',"付款方式,");
//        echo iconv('UTF-8','gb2312',"配送费,");
//        echo iconv('UTF-8','gb2312',"合计,");
//        echo iconv('UTF-8','gb2312',"咨询时间,");
//        echo iconv('UTF-8','gb2312',"完成时间,");
//        echo iconv('UTF-8','gb2312',"来源,\n");
//        if(!empty($data)){
//            foreach($data as $k=>$v){
//                echo iconv('UTF-8','gb2312',$v['id'].",");
//                echo iconv('UTF-8','gb2312',$v['sign_id'].",");
//                echo iconv('UTF-8','gb2312',$v['xiao_id'].",");
//                echo iconv('UTF-8','gb2312',$v['shop_name'].",");
//                echo iconv('UTF-8','gb2312',$v['user_id'].",");
//                echo iconv('UTF-8','gb2312',$v['username'].",");
//                echo iconv('UTF-8','gb2312',$v['customer_name'].",");
//                echo iconv('UTF-8','gb2312',$v['customer_tel'].",");
//                echo iconv('UTF-8','gb2312',$v['address'].",");
//                echo iconv('UTF-8','gb2312',$v['fukuan'].",");
//                echo iconv('UTF-8','gb2312',$v['fee'].",");
//                echo iconv('UTF-8','gb2312',$v['total'].",");
//                echo iconv('UTF-8','gb2312',$v['addtime'].",");
//                echo iconv('UTF-8','gb2312',$v['ftime'].",");
//                echo iconv('UTF-8','gb2312',$v['from_id'].",\n");
//
//            }
//        }
    }
    //搜索商品
    function search_goods_list(){
        $goods_list=$this->mendian_model->search_goods_like($_POST['goods_name']);
        if($goods_list){
            $string="<select id='search'>";
            foreach($goods_list as $k=>$v){
                $string.="<option value=".$v['goods_id'].">".$v['goods_name']."&nbsp;&nbsp;".$v['guige']."&nbsp;&nbsp;".$v['company']."</option>";
            }
            $string.="</select>";
            $string.="&nbsp;&nbsp;<a href='javascript:tianjia();'>添加</a>";
            echo $string;
        } else{
            echo 3;
        }
    }
    //删除订单中的商品
    function del_goods($order_id,$user_id,$goods_id){
        $this->mendian_model->del_goods($goods_id);
        echo "<script>setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$user_id."/0';},0);</script>";
    }
    //添加商品
    function add_order_goods($order_id,$user_id,$goods_id){
        $goods= json_decode($this->http_do->doPOST("http://api.yaofang.cn/stock_api/get_goods_hydee/" . $goods_id, '', 30));
        $goods_array=array('0'=>array('goods_id'=>$goods_id));
        $goods_price=$this->get_goods_price($user_id,$goods_array);
        $this->mendian_model->insert_goods_need($goods_id,$order_id,$goods[0]->wareid,$goods[0]->goods_sn,$goods_price[0]['price']);
        echo "<script>setTimeout(function(){window.location.href ='".SITE."mendian/detail_show/".$order_id."/".$user_id."/0';},0);</script>";
    }
    function test(){
        $num=num_to_upper('123');
        echo $num;
//        $array=array();
//        $array['pszMobis']='18253332308';
//        $array['pszMsg']=iconv('UTF-8','gbk',"你好234123");
//        json_decode($this->http_do->doPOST("http://api.yaofang.cn/sms/send?pszMobis=18253332308&pszMsg=123456", "", 30));

    }
    //打印快递面单
    function dayin_kuaidi($order_id,$n){
        $data["n"]=$n;
        $data["order"]=$this->get_order_mess($order_id);
        $data["order"]["tel"]=explode(',',$data["order"]["tel"]);
        $data["order"]['total_upper']=num_to_upper($data["order"]["total"]);
//        echo "<pre>";
//        print_r($data["order"]);
//        echo "</pre>";
        $this->load->view('mendian/dayin_kd_tpl',$data);
    }
	//获取加盟商品信息
	function show_dealer(){
		//查询加盟商
		$data['dealer']		= $this->shopmodel->get_mendian(0);
		$this->load->view('mendian/show_dealer_shipping_fee_tpl',$data);
	}

	//获取经销商运费
	function show_shipping_fee(){
		$dealer_id			= $this->input->get_post('dealer_id',true);
		$shop				= $this->mendian_model->get_dealer_shipping($dealer_id);
        $province_id		= isset($shop['province'])	? $shop['province'] : 0 ;
        $city_id			= isset($shop['city'])		? $shop['city']		: 0 ;

        $info				= array();
        $info['shop']		= $shop;

		$shipping_list		= array(438,2);

		foreach($shipping_list as $shipping_id)
        {
			$get_recive_time	= $this->mendian_model->get_recive_time($dealer_id,$shipping_id);

			foreach($get_recive_time as $k => $val){
				if($val['province_id'] > 0)
                {
					$info['d_'.$shipping_id]['province_shipping_fee']		= $val['shipping_fee'];
					$info['d_'.$shipping_id]['province_next_shipping_fee']	= $val['shipping_next_fee'];
					$info['d_'.$shipping_id]['province_time']				= $val['shipping_receive'];
                }
				if($val['city_id'] > 0){
					$info['d_'.$shipping_id]['city_shipping_fee']			= $val['shipping_fee'];
					$info['d_'.$shipping_id]['city_next_shipping_fee']		= $val['shipping_next_fee'];
					$info['d_'.$shipping_id]['city_time']					= $val['shipping_receive'];
                }
				if($val['city_id'] == 0 && $val['province_id'] == 0){
					$info['d_'.$shipping_id]['other_shipping_fee']			= $val['shipping_fee'];
					$info['d_'.$shipping_id]['other_next_shipping_fee']		= $val['shipping_next_fee'];
					$info['d_'.$shipping_id]['other_time']					= $val['shipping_receive'];
                }
			}
		}
		//$this->Ptr($info);
		$this->load->view('mendian/show_shipping_fee_tpl',$info);
	}
	
	function Ptr($arr){
		echo '<pre>';
		print_r($arr);
		echo '</pre>';
	}
















	
    public function get_hydee(){echo 222;
        $goods_id='146675';
        $wareid = $this->product_stockmodel->getWareId_detail($goods_id);
        print_r($wareid);
    }
}
?>