<?php
/**
 * Created by JetBrains PhpStorm.
 * User: Administrator
 * Date: 13-1-28
 * Time: 上午10:51
 * To change this template use File | Settings | File Templates.
 */
class Shopmodel extends CI_Model {
    function __construct()
    {
        parent::__construct();
        $this->load->database();
    }
    //获取门店
    function get_mendian($id){
        $sql="SELECT shop_id,shop_name,dealer_id FROM md_shop WHERE pid=$id order by shop_name";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取全部门店
    function get_all_mendian(){
        $sql="SELECT shop_id,shop_name FROM md_shop  order by shop_id asc";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //调配
    function tiaopei($arr){
        $sql = "update md_order set shop_id={$arr['shop_id']} where id={$arr['order_id']}";
        $result = $this->db->query($sql);
        return $result;
    }
    //获取未处理需求的总条数
    function get_need_count(){
        $sql="select count(1) as c  from md_order as o,md_shop as s where o.states=0 and o.shop_id=s.shop_id {$_SESSION['where']}";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['c'];
    }
   //获取未处理需求列表
    function get_need($limit,$pageNum){
        $sql="select o.id,o.user_id,o.customer_name ,o.customer_tel ,o.a_name,u.username ,o.shop_id,
                o.addtime,o.from_id,s.shop_name,o.is_chakan from md_order as o,user as u,md_shop as s
                where o.user_id=u.userid and o.shop_id=s.shop_id and o.states=0 {$_SESSION['where']}
                order by o.id desc limit $pageNum,$limit";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取已处理需求的总条数
    function get_need_count_chuli(){
        $sql="select count(1) as c  from md_order as o ,md_shop as s where o.states=1 and o.shop_id=s.shop_id {$_SESSION['where']}";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['c'];
    }
    //获取已处理需求列表
    function get_need_chuli($limit,$pageNum){
        $sql="select o.id,o.user_id,o.customer_name ,o.customer_tel ,o.a_name,o.b_name,u.username ,
                 o.shop_id,o.addtime,o.ctime,o.from_id,s.shop_name from md_order as o,user as u,md_shop as s
                 where o.user_id=u.userid and o.shop_id=s.shop_id and o.states=1 {$_SESSION['where']}
                 order by o.id desc limit $pageNum,$limit";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取已发货需求的总条数
    function get_need_count_fahuo(){
        $sql="select count(1) as c  from md_order as o ,md_shop as s where o.states=2 and o.shop_id=s.shop_id {$_SESSION['where']}";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['c'];
    }
    //获取已发货需求列表
    function get_need_fahuo($limit,$pageNum){
        $sql="select o.id,o.user_id,o.customer_name ,o.customer_tel ,u.username ,o.shop_id,o.addtime,
               o.from_id,s.shop_name,o.sign_id,o.b_name from md_order as o,user as u,md_shop as s
               where o.user_id=u.userid and o.shop_id=s.shop_id and o.states=2 {$_SESSION['where']}
               order by o.id desc limit $pageNum,$limit";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取已成交需求的总条数
    function get_need_count_chengjiao(){
        $sql="select count(1) as c  from md_order as o ,md_shop as s where o.states=3 and o.shop_id=s.shop_id {$_SESSION['where']}";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['c'];
    }
    //获取已成交需求列表
    function get_need_chengjiao($limit,$pageNum){
        $sql="select o.id,o.user_id,o.customer_name ,o.customer_tel ,u.username ,o.shop_id,o.addtime,
                o.from_id,s.shop_name,o.sign_id,o.b_name from md_order as o,user as u,md_shop as s
                where o.user_id=u.userid and o.shop_id=s.shop_id and o.states=3 {$_SESSION['where']}
                order by o.id desc limit $pageNum,$limit";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取回收站总条数
    function get_need_count_del(){
        $sql="select count(1) as c  from md_order as o,md_shop as s where o.states=4 and o.shop_id=s.shop_id {$_SESSION['where']}";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['c'];
    }
    //获取回收站需求列表
    function get_need_del($limit,$pageNum){
        $sql="select o.id,o.user_id,o.customer_name ,o.customer_tel ,u.username ,o.shop_id,o.addtime,o.from_id,
               s.shop_name,o.sign_id,o.del_name ,o.b_name from md_order as o,user as u,md_shop as s
               where o.user_id=u.userid and o.shop_id=s.shop_id and o.states=4 {$_SESSION['where']}
               order by o.id desc limit $pageNum,$limit";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //支付日志
    function pay_user_money($arr){
        $sql = "insert into
        ecs_account_log (recharge_id,
                             user_id,
                          user_money,
                        frozen_money,
                        rank_points,
                          pay_points,
                        change_time,
                        change_desc,
                        change_type,
                            shop_id,
                         admin_name,
                           order_id
                        )values (
                        '{$arr['recharge_id']}',
                        '{$arr['user_id']}',
                        '-{$arr['user_money']}',
                        '{$arr['frozen_money']}',
                        '{$arr['rank_points']}',
                        '{$arr['pay_points']}',
                        '{$arr['change_time']}',
                        '{$arr['change_desc']}',
                        '{$arr['change_type']}',
                        '{$arr['shop_id']}',
                        '{$arr['admin_name']}',
                        '{$arr['order_id']}'
                        ),(
                        '{$arr['recharge_id']}',
                        '{$arr['user_id']}',
                        0,
                        '{$arr['frozen_money']}',
                        '{$arr['user_money']}',
                        '{$arr['user_money']}',
                        '{$arr['change_time']}',
                        '{$arr['change_desc']}',
                        '{$arr['change_type']}',
                        '{$arr['shop_id']}',
                        '{$arr['admin_name']}',
                        '{$arr['order_id']}'
                        )";
        $result = $this->db->query($sql);
        return $result;
    }


    //更新会员的预存款
    function update_acccount($user_id,$money){
        $sql = "update user_account set user_money=user_money-$money where userid=$user_id";
        $result = $this->db->query($sql);
        return $result;
    }
    //获取会员信息
    function get_user_mess($user_id){
        $sql="select o.id,u.userid,u.username,a.user_money  from md_order as o,user as u,user_account as a where o.user_id=a.userid and o.user_id=u.userid and o.user_id=$user_id";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取商品信息
    function get_goods_mess($order_id){
        $sql="select n.id,g.goods_id,g.goods_name,n.goods_num,n.detail,g.goods_sn  from md_need as n,ecs_goods as g where n.goods_id=g.goods_id and n.order_id=$order_id";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取配送信息
    function get_order_mess($order_id){
        $sql="select n.id,n.shop_id,s.shop_name,n.name,n.customer_name,n.customer_tel,n.tel,n.address,n.youbian,n.fee,
                      n.total,n.fukuan,n.sign_id,n.total,n.message,n.kefu_message
              from md_order as n ,md_shop as s
              where  n.shop_id=s.shop_id and n.id=$order_id";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0];
    }
    //获取会员等级
    function get_user_rank($user_id){
        $sql="select user_rank from user_account where userid=$user_id";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //获取价格
    function get_price($user_rank,$goods_id){
        $sql="select user_price from ecs_member_price where user_rank=$user_rank and goods_id=$goods_id";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['user_price'];
    }
    //更新md_need表的商品数量
    function update_md_need($id,$num){
        $sql = "update md_need set goods_num=$num where id=$id";
        $result = $this->db->query($sql);
        return $result;
    }
    //更新md_order表
    function update_md_order($arr){
        $sql = "update md_order set name= '{$arr['name']}',
                                        tel= '{$arr['tel']}',
                                        address= '{$arr['address']}',
                                        fee= '{$arr['fee']}',
                                        total= '{$arr['total']}',
                                        fukuan= '{$arr['fukuan']}',
                                        states= '{$arr['states']}',
                                        b_name= '{$arr['b_name']}',
                                        ctime= '{$arr['ctime']}',
                                        shop_id='{$arr['shop_id']}',
                                        kefu_message='{$arr['kefu_message']}'
                                        where id= '{$arr['id']}'";
        $result = $this->db->query($sql);
        return $result;
    }
    //获取会员地址
    function get_address($user_id){
        $sql="select consignee,mobile,address from ecs_user_address where  user_id=$user_id";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
    //修改为已查看状态
    function is_chakan($id){
        $sql = "update md_order set is_chakan=1 where id=$id";
        $result = $this->db->query($sql);
        return $result;
    }
    //更新为已发货，也就是标记 还没有写入海典号
    function add_order_biaoji($arr){
        $sql = "update md_order set states= '{$arr['states']}',c_name= '{$arr['c_name']}',ftime= '{$arr['ftime']}' where id= '{$arr['id']}'";
        $result = $this->db->query($sql);
        return $result;
    }
    //更新为已成交 写入海典号
    function add_order_chengjiao($arr){
        $sql = "update md_order set sign_id= '{$arr['sign_id']}',states= '{$arr['states']}'  where id= '{$arr['id']}'";
        $result = $this->db->query($sql);
        return $result;
    }
    //删除信息
    function del($id){
        $sql = "update md_order set states=4,del_name='{$_SESSION['username']}' where id=$id";
        $result = $this->db->query($sql);
        return $result;
    }
    //查询总数
    function get_search_count(){
        $sql="select count(1) as c
                      from md_order as o,
                            user as u,
                            md_shop as s
                 where o.user_id=u.userid
                   and o.shop_id=s.shop_id
                        {$_SESSION['search_tj']}";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data[0]['c'];
    }
    //查询列表
    function get_search_oder($limit,$pageNum){
        $sql="select         o.id,
                         o.user_id,
                         u.username,
                         o.customer_name ,
                         o.customer_tel ,
                         o.a_name,
                         o.tel,
                         o.shop_id,
                         s.shop_name,
                         o.addtime,
                         o.from_id,
                         o.addtime,
                         o.total,
                         o.fukuan,
                         o.states
                   from md_order as o,
                            user as u,
                            md_shop as s
                 where o.user_id=u.userid
                   and o.shop_id=s.shop_id
                      {$_SESSION['search_tj']}
                order by o.id desc limit $pageNum,$limit";
        $query = $this->db->query($sql);
        $data = $query->result_array();
        return $data;
    }
}
?>