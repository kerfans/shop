<?php
/**
 * Created by JetBrains PhpStorm.
 * User: Administrator
 * Date: 13-5-8
 * Time: 上午11:54
 * To change this template use File | Settings | File Templates.
 */
class Shop extends CI_Controller {
    private $arr_user=array();
    public function __construct()
    {
        parent::__construct();
        $this->load->helper('url');
        $this->load->model('shopmodel');
        $this->load->library('pagination');

    }
    public function get_hydee(){
        $goods_id='146675';
        $wareid = $this->product_stockmodel->getWareId_detail($goods_id);
    }
    //调配
    public function tiaopei(){
        if(isset($_REQUEST)&&!empty($_REQUEST)){
            $res=$this->shopmodel->tiaopei($_REQUEST);
            $cur_page=$_REQUEST['cur_page'];
            if($res){
                echo "调配成功<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".$_SERVER['HTTP_REFERER'] ."';
									},1000);</script>";
            }else{
                echo "调配失败<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".$_SERVER['HTTP_REFERER'] ."';
									},1000);</script>";
            }
        }
    }
    //需求管理
    public function  display($pageNum=0){
        $count = $this->shopmodel->get_need_count();
        $config['base_url'] =SITE.'shop/display/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination->initialize($config);
        $data["page"] =$this->pagination->create_links();
        $data["order"] =$this->shopmodel->get_need($config['per_page'],$pageNum);
        $cur_page=($this->pagination->cur_page==0)?1:($this->pagination->cur_page);
        $data["serial_num"] =($cur_page-1)*PAGE;
        $this->load->view('display_tpl',$data);
    }
    //处理信息
    public function need_add($order_id,$user_id){
        $data["id"]=$order_id;
        $this->shopmodel->is_chakan($order_id);
        $data["user"]=$this->shopmodel->get_user_mess($user_id);
        $data["goods"]=$this->shopmodel->get_goods_mess($order_id);
        $data["order"]=$this->shopmodel->get_order_mess($order_id);
        $data["goods"]=$this->get_goods_price($user_id,$data["goods"]);//根据会员等级获取价格
        $data["address"]=$this->get_address($user_id);
        $this->load->view('need_add_tpl',$data);
    }
    //根据会员等级计算商品的价格
    public function get_goods_price($user_id,$goods_array){
        $user_rank=$this->shopmodel->get_user_rank($user_id);
        foreach($goods_array as $k=>$v){
            $goods_array[$k]['price']=$this->shopmodel->get_price($user_rank[0]['user_rank'],$v['goods_id']);
        }
        return $goods_array;
    }
    //获取会员的收货地址
    public function get_address($user_id){
        $address=$this->shopmodel->get_address($user_id);
        for($i=0;$i<count($address);$i++){
            $address[$i]=implode("#",$address[$i]);
        }
        return $address;
    }
    //B客服进一步完善需求
    public function add_order(){
        if(isset($_REQUEST)){
             if($_REQUEST['fukuan']==1){//此方式是预存款支付，如果选择此方式就扣除预存款
                 $user=$this->shopmodel->get_user_mess($_REQUEST['user_id']);
                 if($_REQUEST['total']>$user[0]['user_money']){
                     echo "预存款不足，请选择其他付款方式<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".SITE."shop/display';
									},1000);</script>";
                     die();
                 }else{
                     //var_dump($_REQUEST);die();
                     $this->shopmodel->update_acccount($_REQUEST['user_id'],$_REQUEST['total']);//更新预存款
                     $array_log=array();
                     $array_log['recharge_id']=$_REQUEST['shop_id_new'];
                     $array_log['user_id']=$_REQUEST['user_id'];
                     $array_log['user_money']=$_REQUEST['total'];
                     $array_log['frozen_money']=0;
                     $array_log['rank_points']=0;
                     $array_log['pay_points']=0;
                     $array_log['change_time']=time();
                     $array_log['change_desc']="咨询信息:".$_REQUEST['id'];
                     $array_log['change_type']=88;
                     $array_log['shop_id']=$_REQUEST['shop_id_new']==0?$_REQUEST['shop_id_jiu']:$_REQUEST['shop_id_new'];
                     $array_log['admin_name']=$_SESSION['username'];
                     $array_log['order_id']=0;
                     $this->shopmodel->pay_user_money($array_log);//支付预存款日志
                 }
             }
             foreach($_REQUEST['goods'] as $k=>$v){//更新md_need的数量
                     $this->shopmodel->update_md_need($v[0],$v[1]);
             }
             $_REQUEST['shop_id']=$_REQUEST['shop_id_new']==0?$_REQUEST['shop_id_jiu']:$_REQUEST['shop_id_new'];
             $_REQUEST['states']=1;
             $_REQUEST['b_name']=$_SESSION['username'];
             $_REQUEST['ctime']=date('Y-m-d h:i:s');
             $res=$this->shopmodel->update_md_order($_REQUEST);//更新md_order表
            if($res){
                echo "保存成功<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".SITE."shop/display';
									},1000);</script>";
            }else{
                echo "保存失败<script type='text/javascript'>setTimeout(function()
									{
									window.location.href ='".SITE."shop/display';
									},1000);</script>";
            }
        }else{
            echo "非法操作";
        }
    }
    //查看已处理的需求
    public function display_chuli($pageNum=0){
        $count = $this->shopmodel->get_need_count_chuli();
        $config['base_url'] =SITE.'shop/display_chuli/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination->initialize($config);
        $data["page"] =$this->pagination->create_links();
        $data["order"] =$this->shopmodel->get_need_chuli($config['per_page'],$pageNum);
        $cur_page=($this->pagination->cur_page==0)?1:($this->pagination->cur_page);
        $data["serial_num"] =($cur_page-1)*PAGE;
        $this->load->view('display_chuli_tpl',$data);
    }
    //处理信息
    public function need_chuli($order_id,$user_id){
        $data["id"]=$order_id;
        $data["user"]=$this->shopmodel->get_user_mess($user_id);
        $data["goods"]=$this->shopmodel->get_goods_mess($order_id);
        $data["order"]=$this->shopmodel->get_order_mess($order_id);
        $data["goods"]=$this->get_goods_price($user_id,$data["goods"]);
        $this->load->view('need_chuli_tpl',$data);
    }
    //查看已发货的需求列表
    public function display_fahuo($pageNum=0){
        $count = $this->shopmodel->get_need_count_fahuo();
        $config['base_url'] =SITE.'shop/display_fahuo/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination->initialize($config);
        $data["page"] =$this->pagination->create_links();
        $data["order"] =$this->shopmodel->get_need_fahuo($config['per_page'],$pageNum);
        $cur_page=($this->pagination->cur_page==0)?1:($this->pagination->cur_page);
        $data["serial_num"] =($cur_page-1)*PAGE;
        $this->load->view('display_fahuo_tpl',$data);
    }
    //发货信息详情
    public function need_fahuo($order_id,$user_id){
        $data["id"]=$order_id;
        $data["user"]=$this->shopmodel->get_user_mess($user_id);
        $data["goods"]=$this->shopmodel->get_goods_mess($order_id);
        $data["order"]=$this->shopmodel->get_order_mess($order_id);
        $data["goods"]=$this->get_goods_price($user_id,$data["goods"]);
        $this->load->view('need_fahuo_tpl',$data);
    }
    //更新为标记
    public function add_order_biaoji(){
        if(isset($_REQUEST)){
            $_REQUEST['states']=2;
            $_REQUEST['c_name']=$_SESSION['username'];
            $_REQUEST['ftime']=date('Y-m-d h:i:s');
            $res=$this->shopmodel->add_order_biaoji($_REQUEST);//更新md_order表
            if($res){
                echo "确认成功<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".SITE."shop/display_chuli';
									},1000);</script>";
            }else{
                echo "确认失败<script type='text/javascript'>setTimeout(function()
									{
									window.location.href ='".SITE."shop/display_chuli';
									},1000);</script>";
            }
        }else{
            echo "非法操作";
        }
    }
    //更新为已成交
    public function add_order_chengjiao(){
        if(isset($_REQUEST)){
            $_REQUEST['states']=3;
            $res=$this->shopmodel->add_order_chengjiao($_REQUEST);//更新md_order表
            if($res){
                echo "操作成功<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".SITE."shop/display_fahuo';
									},1000);</script>";
            }else{
                echo "确认失败<script type='text/javascript'>setTimeout(function()
									{
									window.location.href ='".SITE."shop/display_fahuo';
									},1000);</script>";
            }
        }else{
            echo "非法操作";
        }
    }
    //查看已成交的需求列表
    public function display_chengjiao($pageNum=0){
        $count = $this->shopmodel->get_need_count_chengjiao();
        $config['base_url'] =SITE.'shop/display_chengjiao/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination->initialize($config);
        $data["page"] =$this->pagination->create_links();
        $data["order"] =$this->shopmodel->get_need_chengjiao($config['per_page'],$pageNum);
        $cur_page=($this->pagination->cur_page==0)?1:($this->pagination->cur_page);
        $data["serial_num"] =($cur_page-1)*PAGE;
        $this->load->view('display_chengjiao_tpl',$data);
    }
    //成交信息详情
    public function need_chengjiao($order_id,$user_id){
        $data["id"]=$order_id;
        $data["user"]=$this->shopmodel->get_user_mess($user_id);
        $data["goods"]=$this->shopmodel->get_goods_mess($order_id);
        $data["order"]=$this->shopmodel->get_order_mess($order_id);
        $data["goods"]=$this->get_goods_price($user_id,$data["goods"]);
        $this->load->view('need_chengjiao_tpl',$data);
    }
    //回收站
    //查看已成交的需求列表
    public function display_del($pageNum=0){
        $count = $this->shopmodel->get_need_count_del();
        $config['base_url'] =SITE.'shop/display_del/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination->initialize($config);
        $data["page"] =$this->pagination->create_links();
        $data["order"] =$this->shopmodel->get_need_del($config['per_page'],$pageNum);
        $cur_page=($this->pagination->cur_page==0)?1:($this->pagination->cur_page);
        $data["serial_num"] =($cur_page-1)*PAGE;
        $this->load->view('display_del_tpl',$data);
    }
    //删除信息
    public function del($id){
        $res=$this->shopmodel->del($id);
        if($res){
            echo "删除成功<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".$_SERVER['HTTP_REFERER'] ."';
									},1000);</script>";
        }else{
            echo "删除失败<script type='text/javascript'>setTimeout(function()
									{window.location.href ='".$_SERVER['HTTP_REFERER'] ."';
									},1000);</script>";
        }
    }
    //获取门店
    function get_mendian($id=1){
        $res=$this->shopmodel->get_mendian($id);
        $string="";
        foreach($res as $k=>$v){
            $shop_id=$v['shop_id'];
            $shop_name=$v['shop_name'];
            $string.="<option value='".$shop_id."'>".$shop_name."</option>";
        }
        echo $string;
    }

    //载入查询界面
    function search(){
        //$data['mendian']=$this->get_all_mendian();
        $this->load->view('search_tpl');
    }

    //查询咨询
    function search_order($pageNum=0){
        if(isset($_REQUEST)&&!empty($_REQUEST)){
            $_SESSION['search_tj']="";
            $tj_display="";
            if($_REQUEST['id']!=""){
                $_SESSION['search_tj'].=" and o.id=".$_REQUEST['id'];
                $tj_display.="&nbsp;&nbsp;编号:".$_REQUEST['id'];
            }
            if($_REQUEST['username']!=""){
                $_SESSION['search_tj'].=" and u.username='".$_REQUEST['username']."'";
                $tj_display.="&nbsp;&nbsp;会员名称:".$_REQUEST['username'];
            }
            if($_REQUEST['customer_name']!=""){
                $_SESSION['search_tj'].=" and o.customer_name='".$_REQUEST['customer_name']."'";
                $tj_display.="&nbsp;&nbsp;客户姓名:".$_REQUEST['customer_name'];
            }
            if($_REQUEST['customer_tel']!=""){
                $_SESSION['search_tj'].=" and o.customer_tel='".$_REQUEST['customer_tel']."'";
                $tj_display.="&nbsp;&nbsp;客户电话:".$_REQUEST['customer_tel'];
            }
            if($_REQUEST['name']!=""){
                $_SESSION['search_tj']=" and o.name='".$_REQUEST['name']."'";
                $tj_display.="&nbsp;&nbsp;收货人姓名:".$_REQUEST['name'];
            }
            if($_REQUEST['tel']!=""){
                $_SESSION['search_tj']=" and o.tel='".$_REQUEST['tel']."'";
                $tj_display.="&nbsp;&nbsp;收货人电话:".$_REQUEST['tel'];
            }
            if($_SESSION['u_pid']!=0){
                $_SESSION['search_tj']=" and s.shop_id='".$_SESSION['u_pid']."'";
            }
            $_SESSION['search_tj']=trim($_SESSION['search_tj']," ");
        }
        $count = $this->shopmodel->get_search_count();
        $config['base_url'] =SITE.'shop/search_order/';
        $config['total_rows'] = $count;
        $config['per_page'] = PAGE;
        $config['last_link'] = '尾页';
        $config['first_link'] = '首页';
        $config['next_link'] = '下一页';
        $config['prev_link'] = '上一页';
        $this->pagination->initialize($config);
        $data["page"] =$this->pagination->create_links();
        $data["order"] =$this->shopmodel->get_search_oder($config['per_page'],$pageNum);
        foreach($data["order"] as $k=>$v){
            if($v['states']==0){
                $data["order"][$k]['states']="未沟通";
            }elseif($v['states']==1){
                $data["order"][$k]['states']="已沟通";
            }elseif($v['states']==2){
                $data["order"][$k]['states']="已标记";
            }elseif($v['states']==3){
                $data["order"][$k]['states']="已确认";
            }elseif($v['states']==4){
                $data["order"][$k]['states']="作废";
            }
        }
        $data["tj_display"] = $tj_display;
        $this->load->view('search_display_tpl',$data);
    }
    //查询详情
    function search_detail($id,$user_id){
        $data["id"]=$id;
        $data["user"]=$this->shopmodel->get_user_mess($user_id);
        $data["goods"]=$this->shopmodel->get_goods_mess($id);
        $data["order"]=$this->shopmodel->get_order_mess($id);
        $data["goods"]=$this->get_goods_price($user_id,$data["goods"]);
        $this->load->view('need_fahuo_tpl',$data);
    }
    //获取全部门店
    function get_all_mendian(){
        $res=$this->shopmodel->get_all_mendian();
        $string="";
        $string.="<option value='0'>请选择门店</option>";
        foreach($res as $k=>$v){
            $shop_id=$v['shop_id'];
            $shop_name=$v['shop_name'];
            $string.="<option value='".$shop_id."'>".$shop_name."</option>";
        }
        echo $string;
    }

    public function add_need(){
        redirect('http://manager.yaofang.cn/notc_new/add_notc_info','location');
    }
    public function reg_user(){
        redirect('http://manager.yaofang.cn/user/user_register','location');
    }

}
?>